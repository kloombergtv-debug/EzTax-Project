<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EzTax Test Interface</title>
    <style>
        body { font-family: system-ui; margin: 0; padding: 20px; background: #f0f2f5; }
        .container { max-width: 800px; margin: 0 auto; }
        .card { background: white; border-radius: 8px; padding: 20px; margin: 15px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header { background: #1976d2; color: white; text-align: center; }
        .btn { background: #1976d2; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        .btn:hover { background: #1565c0; }
        .result { background: #f5f5f5; padding: 15px; border-radius: 4px; margin: 10px 0; font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
        .success { background: #e8f5e8; border-left: 4px solid #4caf50; }
        .error { background: #ffeaea; border-left: 4px solid #f44336; }
        .input-group { margin: 10px 0; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .input-group input, select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card header">
            <h1>EzTax Application Test</h1>
            <p>세금 신고 시스템 개발 테스트</p>
        </div>

        <div class="card">
            <h3>Server Connection Test</h3>
            <button class="btn" onclick="testConnection()">서버 연결 테스트</button>
            <button class="btn" onclick="getCurrentTaxReturn()">세금 신고서 조회</button>
            <div id="connection-status" class="result">연결 테스트를 실행하세요</div>
        </div>

        <div class="card">
            <h3>Tax Return Data Input</h3>
            <div class="input-group">
                <label>First Name</label>
                <input type="text" id="firstName" value="홍길동">
            </div>
            <div class="input-group">
                <label>Last Name</label>
                <input type="text" id="lastName" value="김">
            </div>
            <div class="input-group">
                <label>Filing Status</label>
                <select id="filingStatus">
                    <option value="single">Single</option>
                    <option value="married_joint">Married Filing Jointly</option>
                    <option value="married_separate">Married Filing Separately</option>
                    <option value="head_of_household">Head of Household</option>
                </select>
            </div>
            <div class="input-group">
                <label>Annual Wages ($)</label>
                <input type="number" id="wages" value="75000">
            </div>
            <button class="btn" onclick="saveTaxData()">데이터 저장</button>
            <div id="save-result" class="result"></div>
        </div>

        <div class="card">
            <h3>Tax Calculation</h3>
            <button class="btn" onclick="calculateTax()">세금 계산</button>
            <div id="calc-result" class="result"></div>
        </div>

        <div class="card">
            <h3>Application URLs</h3>
            <p>다음 URL들을 새 탭에서 열어보세요:</p>
            <ul>
                <li><a href="https://3e18f96e-0fbf-4af6-b766-cfbae9f2437b-00-17nnd6cbvtwuy.janeway.replit.dev/" target="_blank">Direct Replit URL</a></li>
                <li><a href="http://localhost:5000" target="_blank">Localhost (if running locally)</a></li>
            </ul>
        </div>
    </div>

    <script>
        const API_BASE = 'https://3e18f96e-0fbf-4af6-b766-cfbae9f2437b-00-17nnd6cbvtwuy.janeway.replit.dev';
        const FALLBACK_API = 'http://localhost:5000';
        let currentTaxReturn = null;

        async function makeRequest(endpoint, options = {}) {
            const urls = [API_BASE + endpoint, FALLBACK_API + endpoint];
            
            for (const url of urls) {
                try {
                    const response = await fetch(url, {
                        ...options,
                        headers: {
                            'Content-Type': 'application/json',
                            ...options.headers
                        }
                    });
                    return response;
                } catch (error) {
                    continue;
                }
            }
            throw new Error('All API endpoints failed');
        }

        async function testConnection() {
            const statusDiv = document.getElementById('connection-status');
            statusDiv.textContent = 'Testing connection...';
            statusDiv.className = 'result';

            try {
                const response = await makeRequest('/api/tax-return');
                const data = await response.json();
                
                statusDiv.textContent = `Connection successful!\nStatus: ${response.status}\nResponse: ${JSON.stringify(data, null, 2)}`;
                statusDiv.className = 'result success';
                currentTaxReturn = data;
            } catch (error) {
                statusDiv.textContent = `Connection failed: ${error.message}`;
                statusDiv.className = 'result error';
            }
        }

        async function getCurrentTaxReturn() {
            const statusDiv = document.getElementById('connection-status');
            statusDiv.textContent = 'Loading tax return...';

            try {
                const response = await makeRequest('/api/tax-return');
                const data = await response.json();
                
                currentTaxReturn = data;
                statusDiv.textContent = `Tax Return ID: ${data.id}\nUser ID: ${data.userId}\nStatus: ${data.status}\nFirst Name: ${data.personalInfo?.firstName || 'Not set'}\nWages: $${data.income?.wages || 0}`;
                statusDiv.className = 'result success';

                // Populate form with current data
                if (data.personalInfo) {
                    document.getElementById('firstName').value = data.personalInfo.firstName || '';
                    document.getElementById('lastName').value = data.personalInfo.lastName || '';
                    document.getElementById('filingStatus').value = data.personalInfo.filingStatus || 'single';
                }
                if (data.income) {
                    document.getElementById('wages').value = data.income.wages || 0;
                }
            } catch (error) {
                statusDiv.textContent = `Failed to load: ${error.message}`;
                statusDiv.className = 'result error';
            }
        }

        async function saveTaxData() {
            const resultDiv = document.getElementById('save-result');
            resultDiv.textContent = 'Saving data...';
            resultDiv.className = 'result';

            const taxData = {
                userId: 1,
                taxYear: 2025,
                status: 'in_progress',
                personalInfo: {
                    firstName: document.getElementById('firstName').value,
                    lastName: document.getElementById('lastName').value,
                    filingStatus: document.getElementById('filingStatus').value,
                    ssn: '',
                    dateOfBirth: '',
                    email: '',
                    phone: '',
                    address1: '',
                    city: '',
                    state: '',
                    zipCode: '',
                    isDisabled: false,
                    isNonresidentAlien: false,
                    dependents: []
                },
                income: {
                    wages: parseFloat(document.getElementById('wages').value) || 0,
                    totalIncome: parseFloat(document.getElementById('wages').value) || 0,
                    adjustedGrossIncome: parseFloat(document.getElementById('wages').value) || 0,
                    otherEarnedIncome: 0,
                    interestIncome: 0,
                    dividends: 0,
                    businessIncome: 0,
                    capitalGains: 0,
                    rentalIncome: 0,
                    retirementIncome: 0,
                    unemploymentIncome: 0,
                    otherIncome: 0,
                    adjustments: {
                        studentLoanInterest: 0,
                        retirementContributions: 0,
                        otherAdjustments: 0
                    }
                }
            };

            try {
                const method = currentTaxReturn?.id ? 'PUT' : 'POST';
                const endpoint = currentTaxReturn?.id ? `/api/tax-return/${currentTaxReturn.id}` : '/api/tax-return';
                
                const response = await makeRequest(endpoint, {
                    method: method,
                    body: JSON.stringify(taxData)
                });

                const result = await response.json();
                currentTaxReturn = result;
                
                resultDiv.textContent = `Saved successfully!\nID: ${result.id}\nStatus: ${response.status}`;
                resultDiv.className = 'result success';
            } catch (error) {
                resultDiv.textContent = `Save failed: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }

        async function calculateTax() {
            const resultDiv = document.getElementById('calc-result');
            
            if (!currentTaxReturn) {
                resultDiv.textContent = 'Please load or save tax return data first';
                resultDiv.className = 'result error';
                return;
            }

            const wages = parseFloat(document.getElementById('wages').value) || 0;
            const filingStatus = document.getElementById('filingStatus').value;
            
            // Basic tax calculation
            const standardDeduction = filingStatus === 'married_joint' ? 29200 : 14600;
            const taxableIncome = Math.max(0, wages - standardDeduction);
            
            // Simple tax brackets (2024)
            let federalTax = 0;
            if (filingStatus === 'single') {
                if (taxableIncome <= 11600) federalTax = taxableIncome * 0.10;
                else if (taxableIncome <= 47150) federalTax = 1160 + (taxableIncome - 11600) * 0.12;
                else if (taxableIncome <= 100525) federalTax = 5426 + (taxableIncome - 47150) * 0.22;
                else federalTax = 17168.5 + (taxableIncome - 100525) * 0.24;
            }
            
            const refundAmount = Math.max(0, 0 - federalTax);
            const amountOwed = Math.max(0, federalTax - 0);

            resultDiv.innerHTML = `
<strong>Tax Calculation Results:</strong>

Total Income: $${wages.toLocaleString()}
Filing Status: ${filingStatus}
Standard Deduction: $${standardDeduction.toLocaleString()}
Taxable Income: $${taxableIncome.toLocaleString()}
Federal Tax: $${Math.round(federalTax).toLocaleString()}

${refundAmount > 0 ? 
    `Expected Refund: $${Math.round(refundAmount).toLocaleString()}` :
    `Amount Owed: $${Math.round(amountOwed).toLocaleString()}`}
            `;
            resultDiv.className = 'result success';
        }

        // Auto-load on page start
        window.onload = function() {
            testConnection();
        };
    </script>
</body>
</html>