<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EzTax - 세금 신고 시스템</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            font-size: 2.5rem;
            color: #2563eb;
            margin-bottom: 10px;
        }
        
        .status-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        .tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 5px;
            margin-bottom: 20px;
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            border-radius: 10px;
            cursor: pointer;
            color: white;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .tab.active {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }
        
        .tab-content {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        .btn {
            background: linear-gradient(45deg, #3b82f6, #1d4ed8);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, #6b7280, #4b5563);
        }
        
        .result-box {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .success {
            background: #ecfdf5;
            border-color: #6ee7b7;
            color: #065f46;
        }
        
        .error {
            background: #fef2f2;
            border-color: #fca5a5;
            color: #dc2626;
        }
        
        .calculation-summary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
        }
        
        .calculation-summary h3 {
            margin-bottom: 15px;
            font-size: 1.5rem;
        }
        
        .calc-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .progress-steps {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
        }
        
        .step {
            flex: 1;
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            margin: 0 5px;
            border-radius: 10px;
            color: white;
        }
        
        .step.completed {
            background: rgba(34, 197, 94, 0.3);
        }
        
        .step.current {
            background: rgba(59, 130, 246, 0.3);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h1>🧾 EzTax</h1>
            <p>간편한 세금 신고 시스템</p>
            <div id="connection-status" class="status-card">
                <strong>서버 연결 상태:</strong> 확인 중...
            </div>
        </div>

        <div class="progress-steps">
            <div class="step completed">1. 개인정보</div>
            <div class="step current">2. 소득정보</div>
            <div class="step">3. 공제</div>
            <div class="step">4. 세액공제</div>
            <div class="step">5. 추가세금</div>
            <div class="step">6. 검토계산</div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="showTab('personal')">개인정보</div>
            <div class="tab" onclick="showTab('income')">소득</div>
            <div class="tab" onclick="showTab('deductions')">공제</div>
            <div class="tab" onclick="showTab('calculate')">계산</div>
        </div>

        <div id="personal" class="tab-content active">
            <h2>개인정보 입력</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>이름 (First Name)</label>
                    <input type="text" id="firstName" placeholder="홍길동">
                </div>
                <div class="form-group">
                    <label>성 (Last Name)</label>
                    <input type="text" id="lastName" placeholder="김">
                </div>
                <div class="form-group">
                    <label>SSN</label>
                    <input type="text" id="ssn" placeholder="123-45-6789">
                </div>
                <div class="form-group">
                    <label>생년월일</label>
                    <input type="date" id="dateOfBirth">
                </div>
                <div class="form-group">
                    <label>신고 유형</label>
                    <select id="filingStatus">
                        <option value="single">Single</option>
                        <option value="married_joint">Married Filing Jointly</option>
                        <option value="married_separate">Married Filing Separately</option>
                        <option value="head_of_household">Head of Household</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>이메일</label>
                    <input type="email" id="email" placeholder="example@email.com">
                </div>
            </div>
            <button class="btn" onclick="savePersonalInfo()">개인정보 저장</button>
            <div id="personal-result" class="result-box"></div>
        </div>

        <div id="income" class="tab-content">
            <h2>소득정보 입력</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>연간 급여 ($)</label>
                    <input type="number" id="wages" placeholder="75000">
                </div>
                <div class="form-group">
                    <label>이자 소득 ($)</label>
                    <input type="number" id="interestIncome" placeholder="0">
                </div>
                <div class="form-group">
                    <label>배당 소득 ($)</label>
                    <input type="number" id="dividends" placeholder="0">
                </div>
                <div class="form-group">
                    <label>사업 소득 ($)</label>
                    <input type="number" id="businessIncome" placeholder="0">
                </div>
                <div class="form-group">
                    <label>자본 이득 ($)</label>
                    <input type="number" id="capitalGains" placeholder="0">
                </div>
                <div class="form-group">
                    <label>기타 소득 ($)</label>
                    <input type="number" id="otherIncome" placeholder="0">
                </div>
            </div>
            <button class="btn" onclick="saveIncomeInfo()">소득정보 저장</button>
            <div id="income-result" class="result-box"></div>
        </div>

        <div id="deductions" class="tab-content">
            <h2>공제 정보</h2>
            <div class="form-group">
                <label>
                    <input type="radio" name="deductionType" value="standard" checked onchange="toggleDeductionType()">
                    표준공제 사용
                </label>
            </div>
            <div class="form-group">
                <label>
                    <input type="radio" name="deductionType" value="itemized" onchange="toggleDeductionType()">
                    항목별 공제 사용
                </label>
            </div>
            
            <div id="itemized-deductions" style="display: none;">
                <div class="form-grid">
                    <div class="form-group">
                        <label>의료비 ($)</label>
                        <input type="number" id="medicalExpenses" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>주/지방세 (SALT) ($)</label>
                        <input type="number" id="saltTax" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>부동산세 ($)</label>
                        <input type="number" id="realEstateTax" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>모기지 이자 ($)</label>
                        <input type="number" id="mortgageInterest" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>자선기부금 ($)</label>
                        <input type="number" id="charitableDonations" placeholder="0">
                    </div>
                </div>
            </div>
            <button class="btn" onclick="saveDeductions()">공제정보 저장</button>
            <div id="deductions-result" class="result-box"></div>
        </div>

        <div id="calculate" class="tab-content">
            <h2>세금 계산 및 결과</h2>
            <button class="btn" onclick="calculateTaxes()">세금 계산하기</button>
            <button class="btn btn-secondary" onclick="loadCurrentData()">현재 데이터 불러오기</button>
            
            <div id="calculation-result" class="calculation-summary" style="display: none;">
                <h3>계산 결과</h3>
                <div id="tax-summary"></div>
            </div>
            
            <div id="calculate-result" class="result-box"></div>
        </div>
    </div>

    <script>
        const API_URLS = [
            'https://3e18f96e-0fbf-4af6-b766-cfbae9f2437b-00-17nnd6cbvtwuy.janeway.replit.dev',
            'http://localhost:5000'
        ];
        
        let currentTaxReturn = null;
        let activeApiUrl = null;

        async function makeAPIRequest(endpoint, options = {}) {
            for (const baseUrl of API_URLS) {
                try {
                    const response = await fetch(baseUrl + endpoint, {
                        ...options,
                        headers: {
                            'Content-Type': 'application/json',
                            ...options.headers
                        }
                    });
                    
                    if (response.ok) {
                        activeApiUrl = baseUrl;
                        return response;
                    }
                } catch (error) {
                    continue;
                }
            }
            throw new Error('모든 API 엔드포인트 연결 실패');
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        function toggleDeductionType() {
            const itemizedDiv = document.getElementById('itemized-deductions');
            const useItemized = document.querySelector('input[name="deductionType"]:checked').value === 'itemized';
            itemizedDiv.style.display = useItemized ? 'block' : 'none';
        }

        async function checkConnection() {
            const statusDiv = document.getElementById('connection-status');
            
            try {
                const response = await makeAPIRequest('/api/tax-return');
                const data = await response.json();
                
                statusDiv.innerHTML = `<strong>서버 연결:</strong> 성공 ✅<br><strong>활성 URL:</strong> ${activeApiUrl}`;
                statusDiv.className = 'status-card success';
                currentTaxReturn = data;
                
                // 기존 데이터로 폼 채우기
                populateFormWithData(data);
                
            } catch (error) {
                statusDiv.innerHTML = `<strong>서버 연결:</strong> 실패 ❌<br><strong>오류:</strong> ${error.message}`;
                statusDiv.className = 'status-card error';
            }
        }

        function populateFormWithData(data) {
            if (data.personalInfo) {
                const personal = data.personalInfo;
                document.getElementById('firstName').value = personal.firstName || '';
                document.getElementById('lastName').value = personal.lastName || '';
                document.getElementById('ssn').value = personal.ssn || '';
                document.getElementById('dateOfBirth').value = personal.dateOfBirth || '';
                document.getElementById('filingStatus').value = personal.filingStatus || 'single';
                document.getElementById('email').value = personal.email || '';
            }
            
            if (data.income) {
                const income = data.income;
                document.getElementById('wages').value = income.wages || 0;
                document.getElementById('interestIncome').value = income.interestIncome || 0;
                document.getElementById('dividends').value = income.dividends || 0;
                document.getElementById('businessIncome').value = income.businessIncome || 0;
                document.getElementById('capitalGains').value = income.capitalGains || 0;
                document.getElementById('otherIncome').value = income.otherIncome || 0;
            }
        }

        async function savePersonalInfo() {
            const resultDiv = document.getElementById('personal-result');
            resultDiv.textContent = '저장 중...';
            resultDiv.className = 'result-box';

            const personalData = {
                userId: 1,
                taxYear: 2025,
                status: 'in_progress',
                personalInfo: {
                    firstName: document.getElementById('firstName').value,
                    lastName: document.getElementById('lastName').value,
                    ssn: document.getElementById('ssn').value,
                    dateOfBirth: document.getElementById('dateOfBirth').value,
                    email: document.getElementById('email').value,
                    phone: '',
                    address1: '',
                    city: '',
                    state: '',
                    zipCode: '',
                    filingStatus: document.getElementById('filingStatus').value,
                    isDisabled: false,
                    isNonresidentAlien: false,
                    dependents: []
                }
            };

            try {
                const method = currentTaxReturn?.id ? 'PUT' : 'POST';
                const endpoint = currentTaxReturn?.id ? `/api/tax-return/${currentTaxReturn.id}` : '/api/tax-return';
                
                const response = await makeAPIRequest(endpoint, {
                    method: method,
                    body: JSON.stringify(personalData)
                });

                const result = await response.json();
                currentTaxReturn = result;
                
                resultDiv.textContent = `개인정보 저장 완료!\nID: ${result.id}`;
                resultDiv.className = 'result-box success';
                
            } catch (error) {
                resultDiv.textContent = `저장 실패: ${error.message}`;
                resultDiv.className = 'result-box error';
            }
        }

        async function saveIncomeInfo() {
            if (!currentTaxReturn) {
                document.getElementById('income-result').textContent = '먼저 개인정보를 저장하세요.';
                return;
            }

            const resultDiv = document.getElementById('income-result');
            resultDiv.textContent = '소득정보 저장 중...';

            const wages = parseFloat(document.getElementById('wages').value) || 0;
            const interestIncome = parseFloat(document.getElementById('interestIncome').value) || 0;
            const dividends = parseFloat(document.getElementById('dividends').value) || 0;
            const businessIncome = parseFloat(document.getElementById('businessIncome').value) || 0;
            const capitalGains = parseFloat(document.getElementById('capitalGains').value) || 0;
            const otherIncome = parseFloat(document.getElementById('otherIncome').value) || 0;

            const totalIncome = wages + interestIncome + dividends + businessIncome + capitalGains + otherIncome;

            const incomeData = {
                ...currentTaxReturn,
                income: {
                    wages,
                    interestIncome,
                    dividends,
                    businessIncome,
                    capitalGains,
                    otherIncome,
                    totalIncome,
                    adjustedGrossIncome: totalIncome,
                    otherEarnedIncome: 0,
                    rentalIncome: 0,
                    retirementIncome: 0,
                    unemploymentIncome: 0,
                    adjustments: {
                        studentLoanInterest: 0,
                        retirementContributions: 0,
                        otherAdjustments: 0
                    }
                }
            };

            try {
                const response = await makeAPIRequest(`/api/tax-return/${currentTaxReturn.id}`, {
                    method: 'PUT',
                    body: JSON.stringify(incomeData)
                });

                const result = await response.json();
                currentTaxReturn = result;
                
                resultDiv.textContent = `소득정보 저장 완료!\n총소득: $${totalIncome.toLocaleString()}`;
                resultDiv.className = 'result-box success';
                
            } catch (error) {
                resultDiv.textContent = `저장 실패: ${error.message}`;
                resultDiv.className = 'result-box error';
            }
        }

        async function saveDeductions() {
            if (!currentTaxReturn) {
                document.getElementById('deductions-result').textContent = '먼저 개인정보와 소득정보를 입력하세요.';
                return;
            }

            const resultDiv = document.getElementById('deductions-result');
            resultDiv.textContent = '공제정보 저장 중...';

            const useStandardDeduction = document.querySelector('input[name="deductionType"]:checked').value === 'standard';
            const filingStatus = currentTaxReturn.personalInfo?.filingStatus || 'single';
            
            let standardDeductionAmount = 14600; // 2024 single
            if (filingStatus === 'married_joint') standardDeductionAmount = 29200;
            else if (filingStatus === 'head_of_household') standardDeductionAmount = 21900;

            const deductionsData = {
                ...currentTaxReturn,
                deductions: {
                    useStandardDeduction,
                    standardDeductionAmount,
                    totalDeductions: useStandardDeduction ? standardDeductionAmount : 0
                }
            };

            if (!useStandardDeduction) {
                const medicalExpenses = parseFloat(document.getElementById('medicalExpenses').value) || 0;
                const saltTax = parseFloat(document.getElementById('saltTax').value) || 0;
                const realEstateTax = parseFloat(document.getElementById('realEstateTax').value) || 0;
                const mortgageInterest = parseFloat(document.getElementById('mortgageInterest').value) || 0;
                const charitableDonations = parseFloat(document.getElementById('charitableDonations').value) || 0;

                const itemizedTotal = medicalExpenses + saltTax + realEstateTax + mortgageInterest + charitableDonations;

                deductionsData.deductions.itemizedDeductions = {
                    medicalExpenses,
                    stateLocalIncomeTax: saltTax,
                    realEstateTaxes: realEstateTax,
                    mortgageInterest,
                    charitableCash: charitableDonations,
                    charitableNonCash: 0
                };
                deductionsData.deductions.totalDeductions = Math.max(standardDeductionAmount, itemizedTotal);
            }

            try {
                const response = await makeAPIRequest(`/api/tax-return/${currentTaxReturn.id}`, {
                    method: 'PUT',
                    body: JSON.stringify(deductionsData)
                });

                const result = await response.json();
                currentTaxReturn = result;
                
                resultDiv.textContent = `공제정보 저장 완료!\n총공제액: $${deductionsData.deductions.totalDeductions.toLocaleString()}`;
                resultDiv.className = 'result-box success';
                
            } catch (error) {
                resultDiv.textContent = `저장 실패: ${error.message}`;
                resultDiv.className = 'result-box error';
            }
        }

        async function calculateTaxes() {
            if (!currentTaxReturn) {
                document.getElementById('calculate-result').textContent = '먼저 모든 정보를 입력하고 저장하세요.';
                return;
            }

            const resultDiv = document.getElementById('calculate-result');
            const summaryDiv = document.getElementById('calculation-result');
            const taxSummaryDiv = document.getElementById('tax-summary');

            resultDiv.textContent = '세금 계산 중...';

            try {
                // 현재 데이터로 세금 계산
                const income = currentTaxReturn.income || {};
                const deductions = currentTaxReturn.deductions || {};
                const personalInfo = currentTaxReturn.personalInfo || {};

                const totalIncome = income.totalIncome || 0;
                const totalDeductions = deductions.totalDeductions || 14600;
                const taxableIncome = Math.max(0, totalIncome - totalDeductions);

                // 간단한 연방세 계산 (2024년 기준)
                let federalTax = 0;
                const filingStatus = personalInfo.filingStatus || 'single';

                if (filingStatus === 'single') {
                    if (taxableIncome <= 11600) federalTax = taxableIncome * 0.10;
                    else if (taxableIncome <= 47150) federalTax = 1160 + (taxableIncome - 11600) * 0.12;
                    else if (taxableIncome <= 100525) federalTax = 5426 + (taxableIncome - 47150) * 0.22;
                    else if (taxableIncome <= 191850) federalTax = 17168.5 + (taxableIncome - 100525) * 0.24;
                    else federalTax = 39110.5 + (taxableIncome - 191850) * 0.32;
                }

                federalTax = Math.round(federalTax);
                const refundAmount = Math.max(0, 0 - federalTax);
                const amountOwed = Math.max(0, federalTax - 0);

                // 계산 결과 표시
                taxSummaryDiv.innerHTML = `
                    <div class="calc-row">
                        <span>총 소득:</span>
                        <span>$${totalIncome.toLocaleString()}</span>
                    </div>
                    <div class="calc-row">
                        <span>총 공제액:</span>
                        <span>$${totalDeductions.toLocaleString()}</span>
                    </div>
                    <div class="calc-row">
                        <span>과세 소득:</span>
                        <span>$${taxableIncome.toLocaleString()}</span>
                    </div>
                    <div class="calc-row">
                        <span>연방세:</span>
                        <span>$${federalTax.toLocaleString()}</span>
                    </div>
                    <div class="calc-row" style="border-bottom: none; font-weight: bold; font-size: 1.2rem;">
                        <span>${refundAmount > 0 ? '예상 환급액:' : '납부 예상액:'}</span>
                        <span>${refundAmount > 0 ? '$' + refundAmount.toLocaleString() : '$' + amountOwed.toLocaleString()}</span>
                    </div>
                `;

                summaryDiv.style.display = 'block';
                resultDiv.textContent = '계산 완료!';
                resultDiv.className = 'result-box success';

                // 서버에 계산 결과 저장
                const calculatedData = {
                    ...currentTaxReturn,
                    calculatedResults: {
                        totalIncome,
                        adjustments: 0,
                        adjustedGrossIncome: totalIncome,
                        deductions: totalDeductions,
                        taxableIncome,
                        federalTax,
                        credits: 0,
                        taxDue: federalTax,
                        payments: 0,
                        refundAmount,
                        amountOwed
                    }
                };

                await makeAPIRequest(`/api/tax-return/${currentTaxReturn.id}`, {
                    method: 'PUT',
                    body: JSON.stringify(calculatedData)
                });

            } catch (error) {
                resultDiv.textContent = `계산 실패: ${error.message}`;
                resultDiv.className = 'result-box error';
                summaryDiv.style.display = 'none';
            }
        }

        async function loadCurrentData() {
            try {
                const response = await makeAPIRequest('/api/tax-return');
                const data = await response.json();
                currentTaxReturn = data;
                populateFormWithData(data);
                
                document.getElementById('calculate-result').textContent = '데이터 로드 완료!';
                document.getElementById('calculate-result').className = 'result-box success';
            } catch (error) {
                document.getElementById('calculate-result').textContent = `로드 실패: ${error.message}`;
                document.getElementById('calculate-result').className = 'result-box error';
            }
        }

        // 페이지 로드 시 자동 연결 확인
        window.onload = function() {
            checkConnection();
        };
    </script>
</body>
</html>